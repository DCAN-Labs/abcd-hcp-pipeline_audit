import os
import subprocess
import pandas as pd

def run(command, env={}):
    merged_env = os.environ
    merged_env.update(env)
    process = subprocess.Popen(command, stdout=subprocess.PIPE,
                               stderr=subprocess.STDOUT, shell=True,
                               env=merged_env)
    while True:
        line = process.stdout.readline()
        line = str(line, 'utf-8')[:-1]
        print(line)
        if line == '' and process.poll() != None:
            break
    if process.returncode != 0:
        raise Exception("Non zero return code: %d"%process.returncode)

    if node_status == 1:
        status='ok'
    elif node_status == 2:
        status='in process'
    elif node_status == 3:
        status='failed'
    elif node_status == 4:
        status = 'NO_ABCD-HCP'
    elif node_status == 999:
        status = 'not sure'
    else:
        status = 'pending'

def colormap(val):
    if type(val) == int:
        color='white'
    elif val == "NO_ABCD-HCP" or val == "failed": 
        color='tomato'
    elif val == "NO BIDS":
        color = "darkorange"
    elif val == "pending" or val == "in process" or val == "not sure":
        color='gold'
    elif val == "ok": 
        color='palegreen'
    else:
        color='white'
    return 'background-color: %s' % color

def html_report_wf(session_statuses_df,report_output_dir):       
    # save HTML table
    study_ses_count = len(session_statuses_df)
    pd.set_option('display.max_rows', study_ses_count)
    html = session_statuses_df.copy()
    html.reset_index(drop=True,inplace=True)
    #Set table's class="sortable" so that the script works on it
    htmlstyled = html.style.\
                applymap(colormap).\
                set_properties(**{'font-family':'Helvetica','font-size':'8pt','text-align':'center'}).\
                set_table_styles([{'selector': ' ', 'props': [('font-family', 'Helvetica')]}]).\
                set_table_attributes('class="sortable"').\
                render()
    # Added string to the end of htmlstyled calling the JavaScript
    htmlstyled ="<div id='control'></div>" + '\n' + htmlstyled \
            + '\n' +r"<script>let table=document.querySelector('table'),columnHeaders=table.querySelector('thead').querySelector('tr').querySelectorAll('th'),trows=table.querySelector('tbody').querySelectorAll('tr');function showAllRows(){for(let i=0;i<trows.length;i++)trows[i].style.display=null,trows[i].classList='';let boxes=document.querySelectorAll('input');for(let i=0;i<boxes.length;i++)boxes[i].checked=!0,boxes[i].value=''}function hideRows(colNumber,values){for(let i=0;i<trows.length;i++){let row=trows[i];values.includes(row.children[colNumber].innerHTML)&&(row.style.display='none',row.classList.add(`hidden-col-${colNumber}`))}}function showRows(colNumber,values){for(let i=0;i<trows.length;i++){let row=trows[i];if(values.includes(row.children[colNumber].innerHTML)){let classList=row.classList;classList.remove(`hidden-col-${colNumber}`),classList.value.match(/.*hidden-col.*/)||(row.style.display=null)}}}function getValues(colNumber){let values=[];for(let i=0;i<trows.length;i++){let value=trows[i].children[colNumber].innerHTML;values.includes(value)||values.push(value)}return values}function addHeaderElement(index,element){columnHeaders[index].innerHTML+=element}function createCheckList(title,values,columnNumber){let options='';for(let i=0;i<values.length;i++)options+=`<li><input name='${columnNumber}' type='checkbox' checked='true'/>${values[i]}</li>`;return`<div class='dropdown-check-list'><span class='anchor'>${title}</span><ul class='items'>${options}</ul></div>`}function createSearchBox(title,columnNumber){return`<div class='dropdown-check-list'><span class='anchor'>${title}</span><ul class='items'><li><input id='search${columnNumber}' name='${columnNumber}' type='text' onkeyup='searchBoxFilter(${columnNumber})' placeholder='Type to filter'></li></ul></div>`}function searchBoxFilter(columnNumber){let input,filter,td,txtValue;filter=document.getElementById(`search${columnNumber}`).value.toUpperCase();for(let i=0;i<trows.length;i++){let row=trows[i];td=row.children[columnNumber],td&&(txtValue=td.textContent||td.innerText,txtValue.toUpperCase().indexOf(filter)>-1?(row.classList.remove(`hidden-col-${columnNumber}`),row.classList.value.match(/.*hidden-col.*/)||(row.style.display=null)):(row.style.display='none',row.classList.add(`hidden-col-${columnNumber}`)))}}function addFilters(){for(let i=0;i<columnHeaders.length;i++){let title='Filter',values=getValues(i);values.length<5?addHeaderElement(i,createCheckList(title,values,i)):addHeaderElement(i,createSearchBox(title,i))}}function addSortClicks(){for(let i=0;i<columnHeaders.length;i++)columnHeaders[i].querySelectorAll('div')[1].getElementsByClassName('anchor')[0].addEventListener('click',addSortClick,!1)}function addSortClick(){this.parentElement.classList.contains('visible')?this.parentElement.classList.remove('visible'):this.parentElement.classList.add('visible')}function columnCheckbox(){this.checked?showRows(parseInt(this.name),this.parentElement.innerText):hideRows(parseInt(this.name),this.parentElement.innerText)}function addCheckboxEvents(){for(let i=0;i<columnHeaders.length;i++){let boxes=columnHeaders[i].querySelectorAll('input');for(let j=0;j<boxes.length;j++)boxes[j].addEventListener('change',columnCheckbox)}}function addControls(){let control=document.getElementById('control'),button=document.createElement('button');control.appendChild(button),button.outerHTML=`<button type='button' onclick='showAllRows()'>Show All Rows</button>`}function organizeTHs(){for(let i=0;i<columnHeaders.length;i++){let title=columnHeaders[i].innerText;title||(title='Click Column Title to Sort'),columnHeaders[i].innerHTML=`<div class='title'>${title}</div>`}}function init(){organizeTHs(),addFilters(),addSortClicks(),addCheckboxEvents(),addControls()}init();</script>" \
            + '\n' + r"<script>var stIsIE=/*@cc_on!@*/!1; /*@cc_on @*/ if(sorttable={init:function(){arguments.callee.done||(arguments.callee.done=!0,_timer&&clearInterval(_timer),document.createElement&&document.getElementsByTagName&&(sorttable.DATE_RE=/^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/,forEach(document.getElementsByTagName('table'),(function(table){-1!=table.className.search(/\bsortable\b/)&&sorttable.makeSortable(table)}))))},makeSortable:function(table){if(0==table.getElementsByTagName('thead').length&&(the=document.createElement('thead'),the.appendChild(table.rows[0]),table.insertBefore(the,table.firstChild)),null==table.tHead&&(table.tHead=table.getElementsByTagName('thead')[0]),1==table.tHead.rows.length){sortbottomrows=[];for(var i=0;i<table.rows.length;i++)-1!=table.rows[i].className.search(/\bsortbottom\b/)&&(sortbottomrows[sortbottomrows.length]=table.rows[i]);if(sortbottomrows){null==table.tFoot&&(tfo=document.createElement('tfoot'),table.appendChild(tfo));for(var i=0;i<sortbottomrows.length;i++)tfo.appendChild(sortbottomrows[i]);delete sortbottomrows}headrow=table.tHead.rows[0].cells;for(var i=0;i<headrow.length;i++)headrow[i].className.match(/\bsorttable_nosort\b/)||(mtch=headrow[i].className.match(/\bsorttable_([a-z0-9]+)\b/),mtch&&(override=mtch[1]),mtch&&'function'==typeof sorttable['sort_'+override]?headrow[i].sorttable_sortfunction=sorttable['sort_'+override]:headrow[i].sorttable_sortfunction=sorttable.guessType(table,i),headrow[i].sorttable_columnindex=i,headrow[i].sorttable_tbody=table.tBodies[0],dean_addEvent(headrow[i].querySelector('div'),'click',sorttable.innerSortFunction=function(e){if(-1!=this.parentElement.className.search(/\bsorttable_sorted\b/))return sorttable.reverse(this.parentElement.sorttable_tbody),this.parentElement.className=this.parentElement.className.replace('sorttable_sorted','sorttable_sorted_reverse'),this.parentElement.removeChild(document.getElementById('sorttable_sortfwdind')),sortrevind=document.createElement('span'),sortrevind.id='sorttable_sortrevind',void this.parentElement.appendChild(sortrevind);if(-1!=this.parentElement.className.search(/\bsorttable_sorted_reverse\b/))return sorttable.reverse(this.parentElement.sorttable_tbody),this.parentElement.className=this.parentElement.className.replace('sorttable_sorted_reverse','sorttable_sorted'),this.parentElement.removeChild(document.getElementById('sorttable_sortrevind')),sortfwdind=document.createElement('span'),sortfwdind.id='sorttable_sortfwdind',void this.parentElement.appendChild(sortfwdind);theadrow=this.parentElement.parentNode,forEach(theadrow.childNodes,(function(cell){1==cell.nodeType&&(cell.className=cell.className.replace('sorttable_sorted_reverse',''),cell.className=cell.className.replace('sorttable_sorted',''))})),sortfwdind=document.getElementById('sorttable_sortfwdind'),sortfwdind&&sortfwdind.parentNode.removeChild(sortfwdind),sortrevind=document.getElementById('sorttable_sortrevind'),sortrevind&&sortrevind.parentNode.removeChild(sortrevind),this.parentElement.className+=' sorttable_sorted',sortfwdind=document.createElement('span'),sortfwdind.id='sorttable_sortfwdind',this.parentElement.appendChild(sortfwdind),row_array=[],col=this.parentElement.sorttable_columnindex,rows=this.parentElement.sorttable_tbody.rows;for(var j=0;j<rows.length;j++)row_array[row_array.length]=[sorttable.getInnerText(rows[j].cells[col]),rows[j]];row_array.sort(this.parentElement.sorttable_sortfunction),tb=this.parentElement.sorttable_tbody;for(var j=0;j<row_array.length;j++)tb.appendChild(row_array[j][1]);delete row_array}))}},guessType:function(table,column){sortfn=sorttable.sort_alpha;for(var i=0;i<table.tBodies[0].rows.length;i++)if(text=sorttable.getInnerText(table.tBodies[0].rows[i].cells[column]),''!=text){if(text.match(/^-?[£$¤]?[\d,.]+%?$/))return sorttable.sort_numeric;if(possdate=text.match(sorttable.DATE_RE),possdate){if(first=parseInt(possdate[1]),second=parseInt(possdate[2]),first>12)return sorttable.sort_ddmm;if(second>12)return sorttable.sort_mmdd;sortfn=sorttable.sort_ddmm}}return sortfn},getInnerText:function(node){if(!node)return'';if(hasInputs='function'==typeof node.getElementsByTagName&&node.getElementsByTagName('input').length,null!=node.getAttribute('sorttable_customkey'))return node.getAttribute('sorttable_customkey');if(void 0!==node.textContent&&!hasInputs)return node.textContent.replace(/^\s+|\s+$/g,'');if(void 0!==node.innerText&&!hasInputs)return node.innerText.replace(/^\s+|\s+$/g,'');if(void 0!==node.text&&!hasInputs)return node.text.replace(/^\s+|\s+$/g,'');switch(node.nodeType){case 3:if('input'==node.nodeName.toLowerCase())return node.value.replace(/^\s+|\s+$/g,'');case 4:return node.nodeValue.replace(/^\s+|\s+$/g,'');case 1:case 11:for(var innerText='',i=0;i<node.childNodes.length;i++)innerText+=sorttable.getInnerText(node.childNodes[i]);return innerText.replace(/^\s+|\s+$/g,'');default:return''}},reverse:function(tbody){newrows=[];for(var i=0;i<tbody.rows.length;i++)newrows[newrows.length]=tbody.rows[i];for(var i=newrows.length-1;i>=0;i--)tbody.appendChild(newrows[i]);delete newrows},sort_numeric:function(a,b){return aa=parseFloat(a[0].replace(/[^0-9.-]/g,'')),isNaN(aa)&&(aa=0),bb=parseFloat(b[0].replace(/[^0-9.-]/g,'')),isNaN(bb)&&(bb=0),aa-bb},sort_alpha:function(a,b){return a[0]==b[0]?0:a[0]<b[0]?-1:1},sort_ddmm:function(a,b){return mtch=a[0].match(sorttable.DATE_RE),y=mtch[3],m=mtch[2],d=mtch[1],1==m.length&&(m='0'+m),1==d.length&&(d='0'+d),dt1=y+m+d,mtch=b[0].match(sorttable.DATE_RE),y=mtch[3],m=mtch[2],d=mtch[1],1==m.length&&(m='0'+m),1==d.length&&(d='0'+d),dt2=y+m+d,dt1==dt2?0:dt1<dt2?-1:1},sort_mmdd:function(a,b){return mtch=a[0].match(sorttable.DATE_RE),y=mtch[3],d=mtch[2],m=mtch[1],1==m.length&&(m='0'+m),1==d.length&&(d='0'+d),dt1=y+m+d,mtch=b[0].match(sorttable.DATE_RE),y=mtch[3],d=mtch[2],m=mtch[1],1==m.length&&(m='0'+m),1==d.length&&(d='0'+d),dt2=y+m+d,dt1==dt2?0:dt1<dt2?-1:1},shaker_sort:function(list,comp_func){for(var b=0,t=list.length-1,swap=!0;swap;){swap=!1;for(var i=b;i<t;++i)if(comp_func(list[i],list[i+1])>0){var q=list[i];list[i]=list[i+1],list[i+1]=q,swap=!0}if(t--,!swap)break;for(var i=t;i>b;--i)if(comp_func(list[i],list[i-1])<0){var q=list[i];list[i]=list[i-1],list[i-1]=q,swap=!0}b++}}},document.addEventListener&&document.addEventListener('DOMContentLoaded',sorttable.init,!1),/WebKit/i.test(navigator.userAgent))var _timer=setInterval((function(){/loaded|complete/.test(document.readyState)&&sorttable.init()}),10);function dean_addEvent(element,type,handler){if(element.addEventListener)element.addEventListener(type,handler,!1);else{handler.$$guid||(handler.$$guid=dean_addEvent.guid++),element.events||(element.events={});var handlers=element.events[type];handlers||(handlers=element.events[type]={},element['on'+type]&&(handlers[0]=element['on'+type])),handlers[handler.$$guid]=handler,element['on'+type]=handleEvent}}function removeEvent(element,type,handler){element.removeEventListener?element.removeEventListener(type,handler,!1):element.events&&element.events[type]&&delete element.events[type][handler.$$guid]}function handleEvent(event){var returnValue=!0;event=event||fixEvent(((this.ownerDocument||this.document||this).parentWindow||window).event);var handlers=this.events[event.type];for(var i in handlers)this.$$handleEvent=handlers[i],!1===this.$$handleEvent(event)&&(returnValue=!1);return returnValue}function fixEvent(event){return event.preventDefault=fixEvent.preventDefault,event.stopPropagation=fixEvent.stopPropagation,event}window.onload=sorttable.init,dean_addEvent.guid=1,fixEvent.preventDefault=function(){this.returnValue=!1},fixEvent.stopPropagation=function(){this.cancelBubble=!0},Array.forEach||(Array.forEach=function(array,block,context){for(var i=0;i<array.length;i++)block.call(context,array[i],i,array)}),Function.prototype.forEach=function(object,block,context){for(var key in object)void 0===this.prototype[key]&&block.call(context,object[key],key,object)},String.forEach=function(string,block,context){Array.forEach(string.split(''),(function(chr,index){block.call(context,chr,index,string)}))};var forEach=function(object,block,context){if(object){var resolve=Object;if(object instanceof Function)resolve=Function;else{if(object.forEach instanceof Function)return void object.forEach(block,context);'string'==typeof object?resolve=String:'number'==typeof object.length&&(resolve=Array)}resolve.forEach(object,block,context)}};</script>"\
            + '\n' + r"<style>.dropdown-check-list{display:inline-block}.dropdown-check-list .anchor{position:relative;cursor:pointer;display:inline-block;padding:5px 50px 5px 10px;border:1px solid #ccc}.dropdown-check-list .anchor:after{position:absolute;content:'';border-left:2px solid #000;border-top:2px solid #000;padding:5px;right:10px;top:20%;-moz-transform:rotate(-135deg);-ms-transform:rotate(-135deg);-o-transform:rotate(-135deg);-webkit-transform:rotate(-135deg);transform:rotate(-135deg)}.dropdown-check-list .anchor:active:after{right:8px;top:21%}.dropdown-check-list ul.items{padding:2px;display:none;margin:0;border:1px solid #ccc;border-top:none}.dropdown-check-list ul.items li{list-style:none}.dropdown-check-list.visible .anchor{color:#0094ff}.dropdown-check-list.visible .items{display:block}</style>"
    with open(os.path.join(report_output_dir,"s3_status_report.html"),"w") as fp:
        fp.write(htmlstyled)
